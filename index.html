<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOTV 計算ツール</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="icon-192.png">

<style>
  /* ===== 基本設定 ===== */
  *, *::before, *::after {
    box-sizing: border-box;
  }

  :root {
    --bd: #ddd;
    --muted: #666;
    --main: #0ea5e9;
  }

  html {
    scrollbar-gutter: stable; /* PCタブ切替の横ズレ防止 */
  }

  body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    margin: 16px;
    overflow-y: scroll; /* スクロールバー常時確保 */
  }

  h1 {
    font-size: 18px;
    margin: 0 0 12px;
  }

  /* ===== レイアウト ===== */
  .wrap {
    max-width: 720px;
    width: 100%;
    margin: 0 auto;
  }

  .grid {
    display: grid;
    gap: 12px;
    align-content: start;
  }

  /* ===== タブ ===== */
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .tab {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    font-size: 14px;
  }

  .tab.active {
    background: var(--main);
    color: #fff;
    border-color: var(--main);
    font-weight: 600;
  }

  .tabContent {
    display: none;
    min-height: 100%; /* タブ切替時の高さ揺れ防止 */
  }

  .tabContent.active {
    display: block;
  }

  /* ===== カード ===== */
  .card {
    border: 1px solid var(--bd);
    border-radius: 12px;
    padding: 12px;
    margin: 0;
  }

  .stack {
    display: grid;
    gap: 10px;
    margin-top: 10px;
  }

  /* ===== 横並び（基礎値｜バフ） ===== */
  .row2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* ===== フォーム ===== */
  label {
    display: grid;
    gap: 6px;
    font-size: 13px;
  }

  input,
  select {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 15px;
  }

  /* ===== 結果表示 ===== */
  .resultBox {
    border: 1px solid var(--bd);
    border-radius: 12px;
    padding: 12px;
  }

  .resultLabel {
    font-size: 13px;
    margin-bottom: 6px;
  }

  .result {
    font-size: 26px;
    font-weight: 800;
  }

  .sub {
    font-size: 13px;
    color: #555;
    margin-top: 8px;
    line-height: 1.6;
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>WOTV 計算ツール</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="hit">命中</button>
    <button class="tab" data-tab="crit">クリティカル</button>
  </div>

  <!-- ===== 命中タブ ===== -->
  <div id="tab-hit" class="tabContent active">
    <div class="grid">

      <div class="card">
        <strong>攻撃側（命中）</strong>
        <div class="stack">
         <div class="row2">
           <label>基礎命中率（%）
             <input id="baseHit" type="number" step="0.1">
           </label>

           <label>命中バフ加算（%）
             <input id="hitBuff" type="number" step="0.1">
           </label>
         </div>
          <label>器用さ
            <input id="dex" type="number" step="1" value="500">
          </label>
          <label>運
            <input id="lukAtk" type="number" step="1" value="500">
          </label>
          <label>位置
            <select id="pos">
              <option value="front">正面（+0%）</option>
              <option value="side">側面（+15%）</option>
              <option value="back">背面（+30%）</option>
            </select>
          </label>
        </div>
      </div>

      <div class="card">
        <strong>防御側（回避）</strong>
        <div class="stack">
          <div class="row2">
            <label>基礎回避率（%）
              <input id="baseEva" type="number" step="0.1">
            </label>

            <label>回避バフ加算（%）
              <input id="evaBuff" type="number" step="0.1">
            </label>
          </div>

          <label>素早さ
            <input id="agi" type="number" step="1" value="100">
          </label>
          <label>運
            <input id="lukDef" type="number" step="1" value="500">
          </label>
        </div>
      </div>

      <div class="resultBox">
        <div class="resultLabel">最終命中率</div>
        <div class="result" id="finalHit">-</div>
        <div class="sub" id="detailHit"></div>
      </div>

    </div>
  </div>

  <!-- ===== クリティカルタブ ===== -->
  <div id="tab-crit" class="tabContent">
    <div class="grid">

      <div class="card">
        <strong>攻撃側（クリティカル）</strong>
        <div class="stack">
          <label>基礎クリティカル率（%）
            <input id="baseCrit" type="number" step="0.1" value="20">
          </label>
          <label>クリティカルバフ加算（%）
            <input id="critBuff" type="number" step="0.1" value="0">
          </label>
          <label>器用さ
            <input id="critDex" type="number" step="1" value="500">
          </label>
        </div>
      </div>

      <div class="card">
        <strong>防御側（クリ回避）</strong>
        <div class="stack">
          <label>基礎クリティカル回避率（%）
            <input id="baseCritAvoid" type="number" step="0.1" value="0">
          </label>
          <label>クリティカル回避バフ加算（%）
            <input id="critAvoidBuff" type="number" step="0.1" value="0">
          </label>
          <label>運
            <input id="critLuk" type="number" step="1" value="500">
          </label>
        </div>
      </div>

      <div class="resultBox">
        <div class="resultLabel">最終クリティカル率</div>
        <div class="result" id="finalCrit">-</div>
        <div class="sub" id="detailCrit"></div>
      </div>

    </div>
  </div>
</div>

<script>
  /* ===== 共通 ===== */
  function floor1(v){ return Math.trunc(v*10)/10; }
  function percentToRate(v){ return v/100; }
  function num(id){
    const v=document.getElementById(id).value;
    const n=(v===""||v===null)?0:Number(v);
    return Number.isFinite(n)?n:0;
  }

  /* ===== 命中 ===== */
  function positionBonusPercent(p){
    return p==="side"?15:p==="back"?30:0;
  }
  function calcAccuracy(o){
    return (11/20)*Math.pow(o.dex,0.20)
      + (1/200)*Math.pow(o.luk,0.96)
      - 1
      + percentToRate(o.baseHit)
      + percentToRate(o.hitBuff)
      + percentToRate(positionBonusPercent(o.pos));
  }
  function calcEvasion(o){
    return (11/1000)*Math.pow(o.agi,0.90)
      + (1/200)*Math.pow(o.luk,0.96)
      - 1
      + percentToRate(o.baseEva)
      + percentToRate(o.evaBuff);
  }
  function updateHit(){
    const acc=calcAccuracy({
      baseHit:num("baseHit"),
      hitBuff:num("hitBuff"),
      dex:num("dex"),
      luk:num("lukAtk"),
      pos:document.getElementById("pos").value
    });
    const eva=calcEvasion({
      baseEva:num("baseEva"),
      evaBuff:num("evaBuff"),
      agi:num("agi"),
      luk:num("lukDef")
    });
    const final=acc-eva;
    document.getElementById("finalHit").textContent=`${floor1(final*100).toFixed(1)} %`;
    document.getElementById("detailHit").innerHTML=
      `攻撃側：${floor1(acc*100).toFixed(1)}%<br>防御側：${floor1(eva*100).toFixed(1)}%`;
  }

  /* ===== クリティカル ===== */
  function calcCritical(o){
    return Math.pow(o.dex,0.35)/4 - 1
      + percentToRate(o.baseCrit)
      + percentToRate(o.critBuff);
  }
  function calcCritAvoid(o){
    return Math.pow(o.luk,0.37)/5 - 1
      + percentToRate(o.baseAvoid)
      + percentToRate(o.avoidBuff);
  }
  function updateCrit(){
    const c=calcCritical({
      dex:num("critDex"),
      baseCrit:num("baseCrit"),
      critBuff:num("critBuff")
    });
    const a=calcCritAvoid({
      luk:num("critLuk"),
      baseAvoid:num("baseCritAvoid"),
      avoidBuff:num("critAvoidBuff")
    });
    const final=c-a;
    document.getElementById("finalCrit").textContent=`${floor1(final*100).toFixed(1)} %`;
    document.getElementById("detailCrit").innerHTML=
      `攻撃側：${floor1(c*100).toFixed(1)}%<br>防御側：${floor1(a*100).toFixed(1)}%`;
  }

  /* ===== タブ切替 ===== */
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".tabContent").forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
    });
  });

  document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input",()=>{updateHit();updateCrit();});
    el.addEventListener("change",()=>{updateHit();updateCrit();});
  });

  updateHit();
  updateCrit();

  if("serviceWorker"in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
