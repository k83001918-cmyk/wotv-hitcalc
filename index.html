<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOTV 命中回避計算</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { --bd:#ddd; --muted:#666; }
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    .grid { display: grid; gap: 12px; }
    .card { border: 1px solid var(--bd); border-radius: 12px; padding: 12px; }
    .section-title strong { font-size: 15px; }
    .stack { display: grid; gap: 10px; margin-top: 10px; }
    label { display: grid; gap: 6px; font-size: 13px; }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }
    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; line-height: 1.5; }
    .resultBox { border-radius: 12px; padding: 12px; border: 1px solid var(--bd); }
    .resultLabel { color:#333; font-size: 13px; margin-bottom: 6px; }
    .result { font-size: 26px; font-weight: 800; }
    .sub { color: #555; font-size: 13px; margin-top: 8px; line-height: 1.6; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>WOTV 命中回避計算</h1>

  <div class="grid">

    <div class="card">
      <div class="section-title"><strong>攻撃側（命中）</strong></div>
      <div class="stack">
        <label>基礎命中率（%）
          <input id="baseHit" type="number" step="0.1" value="20">
        </label>
        <label>命中バフ加算（%）
          <input id="hitBuff" type="number" step="0.1" value="0">
        </label>
        <label>器用さ
          <input id="dex" type="number" step="1" value="500">
        </label>
        <label>運
          <input id="lukAtk" type="number" step="1" value="500">
        </label>
        <label>位置（相手に対して）
　　　　　<select id="pos">
 　　　　 　<option value="front">正面（+0%）</option>
  　　　　　<option value="side">側面（+15%）</option>
  　　　　　<option value="back">背面（+30%）</option>
　　　　　</select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><strong>防御側（回避）</strong></div>
      <div class="stack">
        <label>基礎回避率（%）
          <input id="baseEva" type="number" step="0.1" value="20">
        </label>
        <label>回避バフ加算（%）
          <input id="evaBuff" type="number" step="0.1" value="0">
        </label>
        <label>素早さ
          <input id="agi" type="number" step="1" value="100">
        </label>
        <label>運
          <input id="lukDef" type="number" step="1" value="500">
        </label>
      </div>
    </div>

    <div class="resultBox">
      <div class="resultLabel">最終命中率（Accuracy − Evasion）</div>
      <div class="result" id="final">-</div>
      <div class="sub" id="detail"></div>
      <div class="hint">小数点第1位まで（第2位切り捨て）／上限下限なし</div>
    </div>

  </div>
</div>

<script>
  function floor1(value) { return Math.trunc(value * 10) / 10; }
  function percentToRate(value) { return value / 100; }

  function positionBonusPercent(position) {
    switch (position) {
      case "front": return 0;
      case "side":  return 15;
      case "back":  return 30;
      default:      return 0;
    }
  }

  function calcAccuracy({ baseHitPercent, hitBuffPercent, dex, luk, position }) {
    const baseHit = percentToRate(baseHitPercent);
    const hitBuff = percentToRate(hitBuffPercent);
    const pos = percentToRate(positionBonusPercent(position));

    const core =
      (11 / 20) * Math.pow(dex, 0.20) +
      (1 / 200) * Math.pow(luk, 0.96) -
      1;

    return core + baseHit + hitBuff + pos;
  }

  function calcEvasion({ baseEvaPercent, evaBuffPercent, agi, luk }) {
    const baseEva = percentToRate(baseEvaPercent);
    const evaBuff = percentToRate(evaBuffPercent);

    const core =
      (11 / 1000) * Math.pow(agi, 0.90) +
      (1 / 200) * Math.pow(luk, 0.96) -
      1;

    return core + baseEva + evaBuff;
  }

  function calcFinalHitRate({ attacker, defender }) {
    const accRate = calcAccuracy(attacker);
    const evaRate = calcEvasion(defender);
    const finalRate = accRate - evaRate;

    return {
      accuracyPercent: floor1(accRate * 100),
      evasionPercent: floor1(evaRate * 100),
      finalPercent: floor1(finalRate * 100),
    };
  }

  function num(id) {
    const v = document.getElementById(id).value;
    const n = (v === "" || v === null) ? 0 : Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function update() {
    const result = calcFinalHitRate({
      attacker: {
        baseHitPercent: num("baseHit"),
        hitBuffPercent: num("hitBuff"),
        dex: num("dex"),
        luk: num("lukAtk"),
        position: document.getElementById("pos").value
      },
      defender: {
        baseEvaPercent: num("baseEva"),
        evaBuffPercent: num("evaBuff"),
        agi: num("agi"),
        luk: num("lukDef")
      }
    });

    document.getElementById("final").textContent = `${result.finalPercent.toFixed(1)} %`;
    document.getElementById("detail").innerHTML =
      `攻撃側 最終命中率：<b>${result.accuracyPercent.toFixed(1)}%</b><br>` +
      `防御側 最終回避率：<b>${result.evasionPercent.toFixed(1)}%</b>`;
  }

  document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", update);
    el.addEventListener("change", update);
  });
  update();

  // Service Worker 登録（PWA）
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>

